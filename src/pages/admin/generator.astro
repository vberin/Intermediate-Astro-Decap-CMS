---
// src/pages/admin/generator.astro
import BaseLayout from "@layouts/BaseLayout.astro";
---
<BaseLayout title="AI Article Generator" description="Generate a new blog post using AI">
    <main class="generator-container">
        <h1>AI-Генератор Статей для Блога</h1>
        <p>Введите тему или ключевые слова, и AI напишет для вас черновик статьи в формате Markdown.</p>

        <div id="generator-form">
            <div class="form-group">
                <label for="prompt-input">Тема или запрос для статьи:</label>
                <textarea id="prompt-input" placeholder="Например: 'преимущества керамической плитки для ванной в стиле лофт'"></textarea>
            </div>
            
            <div class="form-group">
                <label for="tone-select">Выберите тональность статьи:</label>
                <select id="tone-select">
                    <option value="профессиональном">Профессиональный</option>
                    <option value="дружелюбном">Дружелюбный</option>
                    <option value="информационном">Информационный</option>
                    <option value="убеждающем">Убеждающий</option>
                </select>
            </div>

            <button id="generate-button">Сгенерировать статью</button>
            <div id="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <span>Генерация... Это может занять до 30 секунд.</span>
            </div>
        </div>

        <div id="result-container" style="display: none;">
            <h2>Ваша статья готова!</h2>
            <p>Статья успешно создана и добавлена в ваш блог. Вы можете найти ее в админ-панели.</p>
            <pre id="result-output"></pre>
        </div>
    </main>
</BaseLayout>

<script>
    document.addEventListener('astro:page-load', () => {
        const generateButton = document.getElementById('generate-button');
        const promptInput = document.getElementById('prompt-input');
        const toneSelect = document.getElementById('tone-select'); // Получаем селектор
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultContainer = document.getElementById('result-container');
        const resultOutput = document.getElementById('result-output');

        generateButton.addEventListener('click', async () => {
            const userPrompt = promptInput.value;
            if (!userPrompt.trim()) {
                alert('Пожалуйста, введите тему для статьи.');
                return;
            }

            // --- ИЗМЕНЕНИЕ: Формируем полный промпт с учетом тональности ---
            const tone = toneSelect.value;
            const fullPrompt = `Напиши статью в ${tone} тоне на тему: "${userPrompt}"`;

            loadingIndicator.style.display = 'flex';
            generateButton.style.display = 'none';
            resultContainer.style.display = 'none';

            try {
                const response = await fetch('/.netlify/functions/generate-article', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Отправляем полный промпт
                    body: JSON.stringify({ prompt: fullPrompt }) 
                });

                const responseBody = await response.text();

                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${responseBody || response.statusText}`);
                }
                
                const data = JSON.parse(responseBody);
                
                resultOutput.textContent = `Статья "${data.message.match(/"(.*?)"/)[1]}" успешно создана и добавлена в репозиторий! Обновите страницу админ-панели, чтобы увидеть ее в списке блога.`;
                resultContainer.style.display = 'block';

            } catch (error) {
                console.error('Ошибка при генерации статьи:', error);
                resultOutput.textContent = `Произошла ошибка: ${error.message}. Попробуйте еще раз.`;
                resultContainer.style.display = 'block';
            } finally {
                loadingIndicator.style.display = 'none';
                generateButton.style.display = 'block';
            }
        });
    });
</script>


<style lang="less">
.generator-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    padding-top: 10rem; /* ИСПРАВЛЕНИЕ: Добавлен отступ */
    text-align: center;
}
h1 {
    margin-bottom: 1rem;
}
p {
    margin-bottom: 2rem;
    color: var(--bodyTextColor);
}
#generator-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem; /* Увеличили отступ */
    text-align: left; /* Выравнивание для label */
}
.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
label {
    font-weight: 500;
    font-size: 0.9rem;
}
#prompt-input, #tone-select {
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box; /* Важно для select */
}
#prompt-input {
    min-height: 100px;
    resize: vertical;
}
#generate-button {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: bold;
    color: #fff;
    background-color: var(--primary);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    &:hover {
        opacity: 0.9;
    }
}
#loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    font-size: 1rem;
    color: var(--bodyTextColor);
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(0,0,0,0.1);
        border-left-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
}
#result-container {
    margin-top: 2rem;
    text-align: left;
    h2 {
        text-align: center;
        margin-bottom: 1rem;
    }
    p {
        text-align: center;
    }
    pre {
        background-color: #f7f7f7;
        padding: 1rem;
        border-radius: 8px;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

body.dark-mode {
    p, #loading-indicator span, label {
        color: var(--bodyTextColorWhite);
    }
    #prompt-input, #tone-select, pre {
        background-color: var(--accent);
        border-color: var(--medium);
        color: var(--bodyTextColorWhite);
    }
}
</style>
